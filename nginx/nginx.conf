# nginx/nginx.conf

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    upstream flask_host_up {
        server host.docker.internal:5000;
    }

    upstream grafana_up {
        server grafana:3000;
    }

    server {
        listen 80 default_server;
        server_name 107.99.46.66 grafana.local localhost _;

        # Exclude static resources from auth_request
        location ~* .(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|map)$ {
            proxy_pass http://grafana_up;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization "";
            proxy_http_version 1.1;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        location ~* ^/(api|avatar|public|grafana_api|login|logout)/ {
            proxy_pass http://grafana_up;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization "";
            proxy_http_version 1.1;
        }

        location ~* ^/d/ {
            auth_request /_grafana_auth;
            auth_request_set $auth_user $upstream_http_x_auth_user;
            proxy_set_header X-WEBAUTH-USER $auth_user;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization "";
            
            proxy_http_version 1.1;
            proxy_pass http://grafana_up;
        }

        location / {
            proxy_pass http://grafana_up;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization "";
            proxy_http_version 1.1;
        }

        location = /_grafana_auth {
            internal;
            access_log /var/log/nginx/auth_access.log combined;
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_pass http://flask_host_up/grafana_auth;
            
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_connect_timeout 2s;
            proxy_read_timeout 5s;
            proxy_send_timeout 2s;
        }
         location /health {
            access_log off;
            return 200 "healthy";
            add_header Content-Type text/plain;
        }
    }

#     server {
#         listen 80 default_server;
#         server_name 107.99.46.66 grafana.local localhost _;

#         # Exclude static resources from auth_request
#         location ~* .(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
#             proxy_pass http://grafana_up;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             # CRITICAL: Clear Authorization header to prevent 401s
#             proxy_set_header Authorization "";
#             proxy_http_version 1.1;
#             expires 1y;
#             add_header Cache-Control "public, immutable";
#         }

#         # Exclude Grafana API calls from auth
#         location ~* ^/(api|avatar|public|grafana_api)/ {
#             proxy_pass http://grafana_up;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_set_header Authorization "";
#             proxy_http_version 1.1;
#         }

#         # Exclude health endpoints
#         location ~* ^/(metrics|ping|health|robots.txt)$ {
#             proxy_pass http://grafana_up;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_set_header Authorization "";
#             proxy_http_version 1.1;
#         }

#         # COMPLETELY REMOVE login endpoint exclusion - force auth on everything
#         # This ensures auth proxy handles ALL requests

#         # Main location with auth_request
#         location / {
#             auth_request /_grafana_auth;
#             auth_request_set $auth_user $upstream_http_x_auth_user;

#             # Pass authenticated user to Grafana
#             proxy_set_header X-WEBAUTH-USER $auth_user;

#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
            
#             # CRITICAL: Clear Authorization header to prevent conflicts
#             proxy_set_header Authorization "";
            
#             proxy_http_version 1.1;
#             proxy_pass http://grafana_up;
#         }

#         location = /_grafana_auth {
#             internal;
#             access_log /var/log/nginx/auth_access.log combined;
#             proxy_set_header X-Original-URI $request_uri;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

#             proxy_pass http://flask_host_up/grafana_auth;
            
#             proxy_pass_request_body off;
#             proxy_set_header Content-Length "";
#             proxy_connect_timeout 2s;
#             proxy_read_timeout 5s;
#             proxy_send_timeout 2s;
#         }

#         location /health {
#             access_log off;
#             return 200 "healthy
# ";
#             add_header Content-Type text/plain;
#         }
#     }
}